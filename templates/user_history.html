<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parking History</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background: #f5f5f7;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .nav-custom {
        background: #ffffff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.07);
    }
    .card-soft {
        border: none;
        border-radius: 20px;
        background: #ffffff;
        box-shadow: 0 8px 20px rgba(0,0,0,0.06);
        transition: all 0.2s ease;
    }
    .card-soft:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(0,0,0,0.10);
    }
    .table-modern thead {
        background: #e7e7e9;
    }
    .table-modern tbody tr {
        background: white;
        border-bottom: 10px solid #f5f5f7;
    }
    .badge-soft {
        padding: 8px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    .badge-active {
        background: #ffd60a;
        color: #000;
    }
    .badge-completed {
        background: #34c759;
        color: white;
    }
</style>

</head>

<body>
<div id="app">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg nav-custom py-3">
        <div class="container-fluid">
            <h4 class="fw-bold">ðŸš— Parking History</h4>

            <div>
                <a href="/user" class="btn btn-outline-dark btn-sm me-2">Dashboard</a>
                <a href="/user/book" class="btn btn-outline-dark btn-sm me-2">Book Spot</a>
                <button class="btn btn-dark btn-sm" @click="logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-semibold">Your Parking History</h2>

            <!-- EXPORT CSV BUTTON -->
            <button class="btn btn-success btn-sm" @click="exportCSV">
                â¬‡ Export CSV
            </button>
        </div>

        <!-- Loading -->
        <div v-if="loading" class="text-center mt-5">
            <div class="spinner-border text-dark"></div>
        </div>

        <!-- Empty State -->
        <div v-else-if="history.length === 0" class="alert alert-secondary p-4 rounded-4">
            <h5>No parking history yet</h5>
            <p class="mb-1">
                Start by <a href="/user/book">booking a parking spot</a>.
            </p>
        </div>

        <!-- Data -->
        <div v-else>

            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card card-soft p-4">
                        <h6 class="text-muted mb-1">Total Reservations</h6>
                        <h2 class="fw-bold">[[ history.length ]]</h2>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card card-soft p-4">
                        <h6 class="text-muted mb-1">Total Amount Spent</h6>
                        <h2 class="fw-bold">â‚¹[[ totalSpent.toFixed(2) ]]</h2>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="card card-soft p-4">
                <div class="table-responsive">

                    <table class="table table-modern align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Lot</th>
                                <th>Spot</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Duration</th>
                                <th>Cost</th>
                                <th>Status</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr v-for="r in history" :key="r.reservation_id">

                                <td class="fw-semibold">[[ r.reservation_id ]]</td>
                                <td>[[ r.lot_name ]]</td>

                                <td><span class="badge bg-dark">[[ r.spot_id ]]</span></td>

                                <td>[[ formatDate(r.parking_timestamp) ]]</td>

                                <td>
                                    [[ r.leaving_timestamp ? formatDate(r.leaving_timestamp) : "Active" ]]
                                </td>

                                <td>[[ calculateDuration(r.parking_timestamp, r.leaving_timestamp) ]]</td>

                                <td class="fw-bold">
                                    â‚¹[[ r.total_cost ? r.total_cost.toFixed(2) : "0.00" ]]
                                </td>

                                <td>
                                    <span v-if="r.leaving_timestamp"
                                          class="badge-soft badge-completed">Completed</span>

                                    <span v-else
                                          class="badge-soft badge-active">Active</span>
                                </td>

                            </tr>
                        </tbody>
                    </table>

                </div>
            </div>

        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
const { createApp } = Vue;

createApp({
    delimiters: ['[[', ']]'],

    data() {
        return {
            history: [],
            loading: true
        };
    },

    computed: {
        totalSpent() {
            return this.history.reduce(
                (sum, r) => sum + Number(r.total_cost || 0),
                0
            );
        }
    },

    methods: {

        async fetchHistory() {
            try {
                const token = localStorage.getItem("token");
                if (!token) return this.logout();

                const res = await axios.get("/api/user/history", {
                    headers: { Authorization: `Bearer ${token}` }
                });

                this.history = res.data.sort(
                    (a, b) => new Date(b.parking_timestamp) - new Date(a.parking_timestamp)
                );

            } catch (err) {
                if (err.response?.status === 401) {
                    alert("Session expired. Please login again.");
                    return this.logout();
                }
                console.error("History fetch error:", err);

            } finally {
                this.loading = false;
            }
        },

        async exportCSV() {
    try {
        const token = localStorage.getItem("token");

        // 1. Start export
        const res = await axios.post("/api/user/export_csv", {}, {
            headers: { Authorization: `Bearer ${token}` }
        });

        const taskId = res.data.task_id;
        alert("ðŸ“„ CSV export started! Preparing your file...");

        // 2. Poll for completion
        const poll = setInterval(async () => {
            const statusRes = await axios.get(`/api/user/export_status/${taskId}`, {
                headers: { Authorization: `Bearer ${token}` }
            });

            if (statusRes.data.status === "completed") {
                clearInterval(poll);

                const filename = statusRes.data.filename;

                // 3. Auto-download file
                window.location.href = `/exports/${filename}`;
            }
        }, 2000); // every 2 sec

    } catch (error) {
        console.error("CSV export error:", error);
        alert("Failed to start export.");
    }
}
,


        formatDate(dt) {
            if (!dt) return "â€”";
            const d = new Date(dt);
            return isNaN(d) ? "Invalid" : d.toLocaleString();
        },

        calculateDuration(start, end) {
            if (!start) return "â€”";
            if (!end) return "Ongoing";

            const s = new Date(start);
            const e = new Date(end);
            if (isNaN(s) || isNaN(e)) return "â€”";

            const hours = Math.ceil((e - s) / (1000 * 60 * 60));
            return `${hours} hr${hours !== 1 ? "s" : ""}`;
        },

        logout() {
            localStorage.clear();
            window.location.href = "/";
        }
    },

    mounted() {
        if (!localStorage.getItem("token")) {
            window.location.href = "/";
            return;
        }
        this.fetchHistory();
    }

}).mount("#app");
</script>

</body>
</html>
